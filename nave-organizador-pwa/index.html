<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organizador de Aulas — NAVE</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#3B82F6">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#F6F7FB;
      --card:#FFFFFF;
      --text:#0B1220;
      --muted:#5B677C;
      --line: rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(2,6,23,.10);
      --r:18px;

      --g1:#0ea5ff;
      --g2:#7c3aed;
      --g3:#d946ef;
      --accent: linear-gradient(135deg, var(--g1), var(--g2), var(--g3));
      --accentSoft: linear-gradient(135deg, rgba(14,165,255,.12), rgba(124,58,237,.12), rgba(217,70,239,.12));
      --focus: rgba(14,165,255,.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(124,58,237,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(14,165,255,.10), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(217,70,239,.08), transparent 65%),
        var(--bg);
      color: var(--text);
    }

    .wrap{max-width:1160px; margin:0 auto; padding:22px 16px 36px}
    .top{display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap; margin-bottom:12px}
    .brand{display:flex; align-items:center; gap:12px; min-width: 280px}
    .logo{
      width:52px; height:52px; border-radius:16px;
      background: #fff;
      border:1px solid var(--line);
      overflow:hidden;
      box-shadow: 0 8px 18px rgba(2,6,23,.08);
      display:grid; place-items:center;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .title h1{margin:0; font-size:18px; letter-spacing:.2px}
    .title p{margin:3px 0 0; color:var(--muted); font-size:13px}

    .actions{display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end}
    button{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:750;
      font-size:13px;
      box-shadow: 0 6px 16px rgba(2,6,23,.06);
      user-select:none;
    }
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0px)}
    button.primary{
      border:0;
      color:#fff;
      background: var(--accent);
      box-shadow: 0 14px 26px rgba(124,58,237,.18);
    }
    button.danger{
      color:#991b1b;
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.06);
    }

    .note{
      border:1px dashed rgba(124,58,237,.35);
      background: rgba(124,58,237,.06);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--muted);
      font-size: 12px;
      margin: 0 0 14px;
    }
    .note b{color: var(--text)}

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; align-items:start}

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background: var(--accentSoft);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hd .k{font-weight:900; font-size:14px}
    .hd .s{color:var(--muted); font-size:12px}
    .tag{
      font-size:11px;
      padding:6px 9px;
      border-radius: 999px;
      background:#fff;
      border:1px solid var(--line);
      white-space:nowrap;
      color: var(--text);
    }
    .bd{padding:16px}

    .form{display:grid; grid-template-columns: repeat(12, 1fr); gap:12px}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px}

    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 11px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(14,165,255,.55);
      box-shadow: 0 0 0 4px var(--focus);
    }
    textarea{min-height:120px; resize:vertical; line-height:1.35}

    .span-12{grid-column: span 12}
    .span-3{grid-column: span 3}

    .hint{margin-top:10px; color:var(--muted); font-size:12px}

    .search{display:flex; gap:10px; align-items:center; padding:12px; border-bottom:1px solid var(--line); background: #fff}
    .search input{flex:1}

    .items{padding:12px; display:flex; flex-direction:column; gap:10px; max-height:560px; overflow:auto; background: #fff}
    .item{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      background: rgba(2,6,23,.02);
      display:flex; flex-direction:column; gap:6px;
    }
    .item .row{display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap}
    .meta{color:var(--muted); font-size:12px; line-height:1.25}
    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .footer{margin-top:14px; color:var(--muted); font-size:12px; text-align:right}

    #toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #fff;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--text);
      box-shadow: var(--shadow);
      display:none;
      max-width: 360px;
      z-index: 9999;
    }
    #toast .t{font-weight:900; font-size:13px; margin:0 0 2px}
    #toast .m{font-size:12px; color:var(--muted); margin:0}

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.45);
      display:none;
      z-index: 9998;
      padding: 18px;
    }
    .modal{
      max-width: 980px;
      margin: 0 auto;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mh{
      padding: 14px 16px;
      border-bottom:1px solid var(--line);
      background: var(--accentSoft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal .mh .k{font-weight:900}
    .modal .mb{padding: 14px 16px}
    .modal table{width:100%; border-collapse:collapse; font-size:12px}
    .modal th, .modal td{border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top}
    .modal th{font-size:12px; color: var(--muted)}
    .modal .tools{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .modal .tools input{max-width: 320px}

    @media (max-width:980px){
      .grid{grid-template-columns: 1fr}
      .items{max-height:380px}
      .span-3{grid-column: span 6}
    }
    @media (max-width:560px){
      .span-3{grid-column: span 12}
    }

    @media print {
      body{background:#fff}
      .actions, .right, .footer, .items .btns, .search, #toast, .note{display:none !important}
      .wrap{max-width:none; padding:0}
      .grid{grid-template-columns: 1fr}
      .card{box-shadow:none}
    }
  </style>

  <!-- XLSX (Excel) - precisa existir no documento principal, não no print -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">
          <img alt="NAVE" src="./icon-192.png">
        </div>
        <div class="title">
          <h1>Organizador de Aulas — NAVE</h1>
          <p>Instalável como app (PWA), modo offline, salvamento local, impressão.</p>
        </div>
      </div>

      <div class="actions">
        <button id="btnPrint">Imprimir</button>
        <button id="btnExport">Exportar</button>
        <button id="btnImport">Importar</button>
        <button id="btnPlanExcel">Inserir planejamento (Excel)</button>
        <button id="btnViewPlan">Ver planejamento</button>
      </div>
    </div>

    <div class="note">
      <b>Como instalar no iPhone:</b> abra no Safari → <b>Compartilhar</b> → <b>Adicionar à Tela de Início</b>.
      (Para PWA, precisa estar hospedado em site https.)
    </div>

    <div class="grid">
      <!-- ESQUERDA -->
      <div class="card">
        <div class="hd">
          <div>
            <div class="k">Registro de Aula</div>
            <div class="s" id="subLine">—</div>
          </div>
          <span class="tag" id="saveBadge">Não salvo</span>
        </div>

        <div class="bd">
          <div class="form">
            <div class="span-3">
              <label for="date">Data</label>
              <input id="date" type="date">
            </div>

            <div class="span-3">
              <label for="segment">Segmento</label>
              <select id="segment">
                <option>2º Ano</option>
                <option>3º Ano</option>
                <option>Prevest</option>
              </select>
            </div>

            <div class="span-3">
              <label for="turma">Turma</label>
              <select id="turma">
                <option>ALFA</option>
                <option>BETA</option>
                <option>CAPA</option>
              </select>
            </div>

            <div class="span-3">
              <label for="aula">Aula</label>
              <select id="aula"></select>
            </div>

            <div class="span-12">
              <label for="content">Conteúdo</label>
              <select id="content"></select>
            </div>

            <div class="span-12">
              <label for="realizado">Realizado</label>
              <textarea id="realizado" placeholder="O que foi feito em sala..."></textarea>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button class="primary" id="btnSave" style="min-width:160px;">Salvar</button>
          </div>

          <div class="hint">
            Salvamento por chave <b>Data + Segmento + Turma + Aula</b>. Ao mudar data/turma/aula, carrega automaticamente (se existir).
          </div>
        </div>
      </div>

      <!-- DIREITA -->
      <div class="card right">
        <div class="hd">
          <div>
            <div class="k">Registros salvos</div>
            <div class="s">Carregar / excluir / filtrar</div>
          </div>
          <span class="tag" id="countTag">0</span>
        </div>

        <div class="search">
          <input id="filter" type="text" placeholder="Filtrar por data, turma, conteúdo, texto...">
          <button id="btnClearFilter">Limpar</button>
        </div>

        <div class="bd" style="padding:12px 12px 0;">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div style="flex:1; min-width:240px;">
              <label for="weekSel" style="margin:0 0 6px 2px;">Resumo da semana (segunda a sábado)</label>
              <select id="weekSel" style="width:100%"></select>
            </div>
            <div style="margin-top:18px;">
              <button class="primary" id="btnPrintWeek">Imprimir resumo</button>
            </div>
          </div>
        </div>

        <div class="items" id="list"></div>
      </div>
    </div>

    <div class="footer">
      Desenvolvido por NAVE — Núcleo de Aprendizagem, Valor e Estratégia — Prof. Robson Carneiro.
    </div>
  </div>

  <!-- Inputs ocultos -->
  <input id="fileJson" type="file" accept="application/json" style="display:none">
  <input id="fileExcel" type="file" accept=".xlsx,.xls" style="display:none">

  <!-- Toast -->
  <div id="toast">
    <p class="t" id="toastTitle">Aviso</p>
    <p class="m" id="toastMsg">—</p>
  </div>

  <!-- Modal planejamento -->
  <div class="modal-backdrop" id="planModal">
    <div class="modal">
      <div class="mh">
        <div class="k">Planejamento (importado do Excel)</div>
        <div class="tools">
          <input id="planFilter" type="text" placeholder="Filtrar (apostila, assunto, aula, segmento, turma)">
          <button id="btnClosePlan">Fechar</button>
        </div>
      </div>
      <div class="mb">
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
          <button id="btnClearPlan" class="danger">Apagar planejamento</button>
          <span class="tag" id="planCount">0 itens</span>
        </div>
        <div style="overflow:auto; max-height:60vh;">
          <table>
            <thead>
              <tr>
                <th>Apostila (A)</th>
                <th>Assunto (B)</th>
                <th>Aula (C)</th>
                <th>Segmento (D)</th>
                <th>Turma (E)</th>
              </tr>
            </thead>
            <tbody id="planTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * Storage keys
     **********************/
    const KEY_RECORDS = "nave_records_v1";
    const KEY_PLAN = "nave_plan_v1";

    /**********************
     * Helpers
     **********************/
    function showToast(title, msg, ms = 2600){
      const toast = document.getElementById("toast");
      document.getElementById("toastTitle").textContent = title;
      document.getElementById("toastMsg").textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => { toast.style.display = "none"; }, ms);
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    function toISODate(d){
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      return `${yyyy}-${mm}-${dd}`;
    }

    function formatBR(iso){
      // iso: YYYY-MM-DD
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }

    function safeJSONParse(s, fallback){
      try { return JSON.parse(s); } catch { return fallback; }
    }

    function loadAllRecords(){
      return safeJSONParse(localStorage.getItem(KEY_RECORDS) || "[]", []);
    }

    function saveAllRecords(arr){
      localStorage.setItem(KEY_RECORDS, JSON.stringify(arr));
    }

    function loadPlan(){
      return safeJSONParse(localStorage.getItem(KEY_PLAN) || "[]", []);
    }

    function savePlan(arr){
      localStorage.setItem(KEY_PLAN, JSON.stringify(arr));
    }

    function recordKey({date, segment, turma, aula}){
      return `${date}__${segment}__${turma}__${aula}`;
    }

    function mondayOf(isoDate){
      const d = new Date(isoDate + "T12:00:00");
      const day = d.getDay(); // 0=dom,1=seg...
      const diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      return toISODate(d);
    }

    function addDays(iso, n){
      const d = new Date(iso + "T12:00:00");
      d.setDate(d.getDate() + n);
      return toISODate(d);
    }

    function weekLabel(mondayISO){
      const sat = addDays(mondayISO, 5);
      return `${formatBR(mondayISO)} a ${formatBR(sat)}`;
    }

    function normalizeSegment(s){
      // aceita "2° ANO", "2º Ano", etc.
      if(!s) return "";
      const x = String(s).trim().toLowerCase();
      if(x.includes("2") && x.includes("ano")) return "2º Ano";
      if(x.includes("3") && x.includes("ano")) return "3º Ano";
      if(x.includes("prev")) return "Prevest";
      // fallback: capitaliza
      return String(s).trim();
    }

    function normalizeTurma(s){
      return String(s || "").trim();
    }

    /**********************
     * DOM refs
     **********************/
    const elDate = document.getElementById("date");
    const elSegment = document.getElementById("segment");
    const elTurma = document.getElementById("turma");
    const elAula = document.getElementById("aula");
    const elContent = document.getElementById("content");
    const elRealizado = document.getElementById("realizado");

    const elSubLine = document.getElementById("subLine");
    const elSaveBadge = document.getElementById("saveBadge");

    const elList = document.getElementById("list");
    const elFilter = document.getElementById("filter");
    const elCountTag = document.getElementById("countTag");

    const elWeekSel = document.getElementById("weekSel");

    const btnSave = document.getElementById("btnSave");
    const btnPrint = document.getElementById("btnPrint");
    const btnExport = document.getElementById("btnExport");
    const btnImport = document.getElementById("btnImport");
    const btnPlanExcel = document.getElementById("btnPlanExcel");
    const btnViewPlan = document.getElementById("btnViewPlan");
    const btnPrintWeek = document.getElementById("btnPrintWeek");
    const btnClearFilter = document.getElementById("btnClearFilter");

    const fileJson = document.getElementById("fileJson");
    const fileExcel = document.getElementById("fileExcel");

    const planModal = document.getElementById("planModal");
    const btnClosePlan = document.getElementById("btnClosePlan");
    const btnClearPlan = document.getElementById("btnClearPlan");
    const planTbody = document.getElementById("planTbody");
    const planFilter = document.getElementById("planFilter");
    const planCount = document.getElementById("planCount");

    /**********************
     * State
     **********************/
    let currentLoadedKey = null; // chave do registro carregado (para permitir editar)
    let suppressAutoLoad = false;

    /**********************
     * Planning -> Conteúdo
     **********************/
    function getPlanOptionsFor(segment, turma){
      const plan = loadPlan();
      const seg = normalizeSegment(segment);
      const tur = normalizeTurma(turma);

      const filtered = plan.filter(r =>
        normalizeSegment(r.segmento) === seg &&
        normalizeTurma(r.turma) === tur
      );

      // ordena por aula (num), depois apostila, depois assunto
      filtered.sort((a,b)=>{
        const aa = Number(a.aula) || 0;
        const bb = Number(b.aula) || 0;
        if(aa !== bb) return aa - bb;
        const apA = String(a.apostila ?? "");
        const apB = String(b.apostila ?? "");
        if(apA !== apB) return apA.localeCompare(apB);
        return String(a.assunto ?? "").localeCompare(String(b.assunto ?? ""));
      });

      return filtered;
    }

    function fillContentFromPlan(){
      const seg = elSegment.value;
      const tur = elTurma.value;
      const options = getPlanOptionsFor(seg, tur);

      elContent.innerHTML = "";
      if(options.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "— (sem planejamento para este segmento/turma)";
        elContent.appendChild(opt);
        return;
      }

      // cria lista única por (apostila+assunto+aula)
      const seen = new Set();
      for(const r of options){
        const aulaNum = String(r.aula ?? "").trim();
        const apostila = String(r.apostila ?? "").trim();
        const assunto = String(r.assunto ?? "").trim();
        const key = `${apostila}__${assunto}__${aulaNum}`;
        if(seen.has(key)) continue;
        seen.add(key);

        const opt = document.createElement("option");
        // guardamos um "id" simples no value para localizar depois (não precisa ser único globalmente, só no select)
        opt.value = key;
        const prefix = aulaNum ? `${aulaNum} — ` : "";
        const ap = apostila ? `Apostila ${apostila} • ` : "";
        opt.textContent = `${prefix}${ap}${assunto || "(sem assunto)"}`;
        elContent.appendChild(opt);
      }
    }

    /**********************
     * Aula options (regra de não repetir)
     **********************/
    function usedAulasFor(date, segment, turma){
      const all = loadAllRecords();
      const set = new Set();
      for(const r of all){
        if(r.date === date && r.segment === segment && r.turma === turma){
          set.add(Number(r.aula));
        }
      }
      return set;
    }

    function rebuildAulaOptions(keepAulaIfLoaded){
      const date = elDate.value;
      const segment = elSegment.value;
      const turma = elTurma.value;

      const used = (date && segment && turma) ? usedAulasFor(date, segment, turma) : new Set();

      // aula atual
      const current = Number(elAula.value || 1);

      // lista base (1..30)
      const max = 30;
      const allowed = [];
      for(let i=1;i<=max;i++){
        // se já usado, só permite se for o que está carregado/selecionado (editar)
        if(used.has(i)){
          if(keepAulaIfLoaded && i === current) allowed.push(i);
          continue;
        }
        allowed.push(i);
      }

      // se nada sobrou (muito raro), mantém ao menos o atual
      if(allowed.length === 0) allowed.push(current || 1);

      // repopula select
      const prev = current;
      elAula.innerHTML = "";
      for(const n of allowed){
        const opt = document.createElement("option");
        opt.value = String(n);
        opt.textContent = String(n);
        elAula.appendChild(opt);
      }

      // tenta manter seleção anterior
      const hasPrev = allowed.includes(prev);
      elAula.value = hasPrev ? String(prev) : String(allowed[0]);

      updateHeaderLine();
    }

    /**********************
     * Load / Save record
     **********************/
    function getFormData(){
      return {
        date: elDate.value,
        segment: elSegment.value,
        turma: elTurma.value,
        aula: Number(elAula.value || 1),
        contentValue: elContent.value || "",
        contentLabel: (elContent.selectedOptions[0]?.textContent || "").trim(),
        realizado: elRealizado.value || "",
        updatedAt: new Date().toISOString()
      };
    }

    function setFormData(r){
      suppressAutoLoad = true;
      elDate.value = r.date;
      elSegment.value = r.segment;
      elTurma.value = r.turma;

      fillContentFromPlan();
      rebuildAulaOptions(true);
      elAula.value = String(r.aula);

      // conteúdo: tenta setar pelo value; se não existir, deixa 1ª opção e grava label anterior no badge
      const hasValue = Array.from(elContent.options).some(o => o.value === r.contentValue);
      if(hasValue) elContent.value = r.contentValue;

      elRealizado.value = r.realizado || "";
      currentLoadedKey = recordKey(r);
      elSaveBadge.textContent = "Carregado";
      suppressAutoLoad = false;
      updateHeaderLine();
    }

    function autoLoadIfExists(){
      if(suppressAutoLoad) return;

      const r = getFormData();
      if(!r.date) return;

      const all = loadAllRecords();
      const key = recordKey(r);
      const found = all.find(x => recordKey(x) === key);

      if(found){
        currentLoadedKey = key;
        // mantém aula editável
        rebuildAulaOptions(true);
        // tenta setar conteúdo
        fillContentFromPlan();
        const hasValue = Array.from(elContent.options).some(o => o.value === found.contentValue);
        if(hasValue) elContent.value = found.contentValue;

        elRealizado.value = found.realizado || "";
        elSaveBadge.textContent = "Carregado";
      }else{
        currentLoadedKey = null;
        elRealizado.value = "";
        elSaveBadge.textContent = "Não salvo";
        // modo "novo": remove aulas usadas (não precisa manter aula antiga)
        rebuildAulaOptions(false);
        fillContentFromPlan();
      }
      updateHeaderLine();
    }

    function saveCurrent(){
      const r = getFormData();

      if(!r.date){
        showToast("Faltou a data", "Selecione a data antes de salvar.");
        return;
      }
      if(!r.segment || !r.turma || !r.aula){
        showToast("Campos obrigatórios", "Segmento, turma e aula precisam estar preenchidos.");
        return;
      }

      const all = loadAllRecords();
      const key = recordKey(r);
      const idx = all.findIndex(x => recordKey(x) === key);

      if(idx >= 0){
        all[idx] = { ...all[idx], ...r };
      }else{
        all.push(r);
      }

      saveAllRecords(all);
      currentLoadedKey = key;
      elSaveBadge.textContent = "Salvo";
      showToast("Salvo", "Registro atualizado no dispositivo.");
      renderList();
      // depois de salvar, atualizar regra do seletor de aulas (aula atual deve continuar editável)
      rebuildAulaOptions(true);
      updateWeeks();
    }

    function deleteRecord(key){
      const all = loadAllRecords();
      const next = all.filter(x => recordKey(x) !== key);
      saveAllRecords(next);

      if(currentLoadedKey === key){
        currentLoadedKey = null;
        elSaveBadge.textContent = "Não salvo";
      }

      showToast("Excluído", "Registro removido.");
      renderList();
      updateWeeks();
      // reprocessa aulas disponíveis
      rebuildAulaOptions(false);
    }

    /**********************
     * List rendering
     **********************/
    function renderList(){
      const all = loadAllRecords();
      const q = (elFilter.value || "").trim().toLowerCase();

      const filtered = all
        .slice()
        .sort((a,b) => (a.date < b.date ? 1 : -1))
        .filter(r => {
          if(!q) return true;
          const hay = [
            r.date, r.segment, r.turma, String(r.aula),
            r.contentLabel, r.realizado
          ].join(" ").toLowerCase();
          return hay.includes(q);
        });

      elCountTag.textContent = String(filtered.length);

      elList.innerHTML = "";
      if(filtered.length === 0){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<div class="meta">Nenhum registro encontrado.</div>`;
        elList.appendChild(div);
        return;
      }

      for(const r of filtered){
        const key = recordKey(r);
        const wrap = document.createElement("div");
        wrap.className = "item";

        const title = `${formatBR(r.date)} • ${r.segment} • ${r.turma} • Aula ${r.aula}`;
        const updated = r.updatedAt ? new Date(r.updatedAt).toLocaleString("pt-BR") : "—";

        wrap.innerHTML = `
          <div class="row">
            <div style="font-weight:900; font-size:12px;">${title}</div>
            <span class="tag">Atualizado: ${updated}</span>
          </div>
          <div class="meta"><b>Conteúdo:</b> ${escapeHTML(r.contentLabel || "—")}</div>
          <div class="meta"><b>Realizado:</b><br>${escapeHTML((r.realizado || "").trim() || "—")}</div>
          <div class="btns">
            <button data-action="load" data-key="${key}" class="primary">Carregar</button>
            <button data-action="del" data-key="${key}" class="danger">Excluir</button>
          </div>
        `;
        elList.appendChild(wrap);
      }
    }

    function escapeHTML(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;")
        .replaceAll("\n","<br>");
    }

    /**********************
     * Weeks summary
     **********************/
    function updateWeeks(){
      const all = loadAllRecords();
      const mondaySet = new Set();

      for(const r of all){
        if(!r.date) continue;
        mondaySet.add(mondayOf(r.date));
      }

      const mondays = Array.from(mondaySet).sort((a,b)=> a < b ? 1 : -1);
      elWeekSel.innerHTML = "";

      if(mondays.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "—";
        elWeekSel.appendChild(opt);
        return;
      }

      for(const m of mondays){
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = weekLabel(m);
        elWeekSel.appendChild(opt);
      }
    }

    function buildWeekSummaryHTML(mondayISO){
      const all = loadAllRecords();
      const sat = addDays(mondayISO, 5);

      const week = all
        .filter(r => r.date >= mondayISO && r.date <= sat)
        .slice()
        .sort((a,b)=>{
          if(a.date !== b.date) return a.date < b.date ? -1 : 1;
          if(a.segment !== b.segment) return a.segment.localeCompare(b.segment);
          if(a.turma !== b.turma) return a.turma.localeCompare(b.turma);
          return Number(a.aula) - Number(b.aula);
        });

      if(week.length === 0){
        return `<div class="card"><b>Sem registros</b> nesta semana.</div>`;
      }

      let out = "";
      for(const r of week){
        const title = `${formatBR(r.date)} • ${r.segment} • ${r.turma} • Aula ${r.aula}`;
        out += `
          <div class="card">
            <div class="row">
              <div><b>${escapeHTML(title)}</b></div>
              <div class="tag">${escapeHTML(r.contentLabel || "—")}</div>
            </div>
            <div class="meta" style="margin-top:8px;">
              <b>Realizado:</b><br>${escapeHTML((r.realizado || "").trim() || "—")}
            </div>
          </div>
        `;
      }
      return out;
    }

    function printWeek(){
      const mondayISO = elWeekSel.value;
      if(!mondayISO){
        showToast("Sem semana", "Não há semanas disponíveis para imprimir.");
        return;
      }

      const summaryHTML = buildWeekSummaryHTML(mondayISO);
      const safeSummary = summaryHTML; // já vem escapado no conteúdo

      // IMPORTANTE: não carregar scripts externos no print (evita bloqueios + não precisa)
      const htmlToPrint = `
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumo semanal — Organizador de Aulas (NAVE)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; color:#111; }
    h1 { font-size: 16px; margin: 0 0 10px; }
    .sub { color:#444; font-size: 12px; margin-bottom: 14px; }
    .card { border:1px solid #ddd; border-radius: 12px; padding: 12px; margin: 10px 0; }
    .row { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .tag { font-size: 12px; padding: 6px 10px; border-radius: 999px; background:#f4f4f5; border:1px solid #e4e4e7; }
    .meta { font-size: 12px; color:#333; line-height:1.35; }
    .meta b { color:#111; }
    @media print { body{ margin:0 } }
  </style>
</head>
<body>
  <h1>Resumo semanal — Organizador de Aulas (NAVE)</h1>
  <div class="sub"><b>Semana:</b> ${weekLabel(mondayISO)} (segunda a sábado) • <b>Gerado em:</b> ${new Date().toLocaleString("pt-BR")}</div>
  ${safeSummary}
  <div class="sub" style="margin-top:14px;">Desenvolvido por NAVE — Núcleo de Aprendizagem, Valor e Estratégia — Prof. Robson Carneiro.</div>
  <script>
    window.onload = () => setTimeout(() => window.print(), 250);
  <\/script>
</body>
</html>
      `.trim();

      const w = window.open("", "_blank");
      if(!w){
        showToast("Popup bloqueado", "Permita popups para imprimir o resumo.");
        return;
      }
      w.document.open();
      w.document.write(htmlToPrint);
      w.document.close();
    }

    /**********************
     * Export / Import JSON
     **********************/
    function exportJSON(){
      const payload = {
        exportedAt: new Date().toISOString(),
        app: "Organizador de Aulas — NAVE",
        version: 1,
        records: loadAllRecords(),
        planning: loadPlan()
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `organizador-aulas-nave_${toISODate(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("Exportado", "Arquivo JSON baixado.");
    }

    function importJSONFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        const data = safeJSONParse(reader.result, null);
        if(!data || typeof data !== "object"){
          showToast("Arquivo inválido", "Não consegui ler esse JSON.");
          return;
        }

        const records = Array.isArray(data.records) ? data.records : [];
        const planning = Array.isArray(data.planning) ? data.planning : [];

        // validação mínima
        const saneRecords = records
          .filter(r => r && r.date && r.segment && r.turma && r.aula != null)
          .map(r => ({
            date: String(r.date),
            segment: String(r.segment),
            turma: String(r.turma),
            aula: Number(r.aula),
            contentValue: String(r.contentValue || ""),
            contentLabel: String(r.contentLabel || ""),
            realizado: String(r.realizado || ""),
            updatedAt: r.updatedAt ? String(r.updatedAt) : new Date().toISOString()
          }));

        const sanePlan = planning
          .filter(r => r && r.assunto != null && r.segmento != null && r.turma != null)
          .map(r => ({
            apostila: String(r.apostila || ""),
            assunto: String(r.assunto || ""),
            aula: String(r.aula || ""),
            segmento: normalizeSegment(r.segmento),
            turma: normalizeTurma(r.turma)
          }));

        saveAllRecords(saneRecords);
        savePlan(sanePlan);

        fillContentFromPlan();
        rebuildAulaOptions(false);
        renderList();
        updateWeeks();

        showToast("Importado", `Registros: ${saneRecords.length} • Planejamento: ${sanePlan.length}`);
      };
      reader.readAsText(file, "utf-8");
    }

    /**********************
     * Planning Excel import
     * Colunas:
     * A: Número da apostila
     * B: Assunto
     * C: Número da aula
     * D: Segmento (2° ANO, 3° ANO e Prevest)
     * E: Turma (OBRIGATÓRIA)
     **********************/
    function importPlanningExcel(file){
      if(typeof XLSX === "undefined"){
        showToast("Falha no Excel", "Biblioteca XLSX não carregou. Verifique sua conexão/redeploy.");
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, {type:"array"});
          const wsName = wb.SheetNames[0];
          const ws = wb.Sheets[wsName];

          // lê em linhas, incluindo vazios
          const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
          if(rows.length < 2){
            showToast("Planilha vazia", "Inclua pelo menos 1 linha de dados.");
            return;
          }

          // assume que a 1ª linha pode ser cabeçalho; vamos importar todas as linhas a partir da 2ª
          const out = [];
          for(let i=1; i<rows.length; i++){
            const row = rows[i] || [];
            const apostila = String(row[0] ?? "").trim(); // A
            const assunto  = String(row[1] ?? "").trim(); // B
            const aula     = String(row[2] ?? "").trim(); // C
            const segmentoRaw = String(row[3] ?? "").trim(); // D
            const turmaRaw    = String(row[4] ?? "").trim(); // E (obrigatória)

            // ignora linhas completamente vazias
            if(!apostila && !assunto && !aula && !segmentoRaw && !turmaRaw) continue;

            const segmento = normalizeSegment(segmentoRaw);

            if(!turmaRaw){
              showToast("Erro no Excel", `Linha ${i+1}: coluna E (Turma) é obrigatória.`);
              return;
            }
            if(!segmento){
              showToast("Erro no Excel", `Linha ${i+1}: coluna D (Segmento) é obrigatória.`);
              return;
            }
            if(!assunto){
              showToast("Erro no Excel", `Linha ${i+1}: coluna B (Assunto) é obrigatória.`);
              return;
            }

            out.push({
              apostila,
              assunto,
              aula,
              segmento,
              turma: normalizeTurma(turmaRaw)
            });
          }

          if(out.length === 0){
            showToast("Nada importado", "Não encontrei linhas válidas para importar.");
            return;
          }

          // salva substituindo o planejamento atual (comportamento mais previsível)
          savePlan(out);
          fillContentFromPlan();
          showToast("Planejamento importado", `${out.length} linhas importadas.`);
          // atualiza modal se estiver aberto
          renderPlanModal();
        }catch(err){
          console.error(err);
          showToast("Falha ao ler Excel", "O arquivo pode estar corrompido ou num formato não suportado.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    /**********************
     * Planning modal
     **********************/
    function openPlanModal(){
      renderPlanModal();
      planModal.style.display = "block";
    }

    function closePlanModal(){
      planModal.style.display = "none";
    }

    function renderPlanModal(){
      const plan = loadPlan();
      const q = (planFilter.value || "").trim().toLowerCase();

      const filtered = plan.filter(r => {
        if(!q) return true;
        const hay = [r.apostila, r.assunto, r.aula, r.segmento, r.turma].join(" ").toLowerCase();
        return hay.includes(q);
      });

      planCount.textContent = `${filtered.length} itens`;
      planTbody.innerHTML = "";

      if(filtered.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="color:#5B677C; padding:12px 8px;">Nenhum item de planejamento.</td>`;
        planTbody.appendChild(tr);
        return;
      }

      for(const r of filtered){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHTML(r.apostila)}</td>
          <td>${escapeHTML(r.assunto)}</td>
          <td>${escapeHTML(r.aula)}</td>
          <td>${escapeHTML(r.segmento)}</td>
          <td>${escapeHTML(r.turma)}</td>
        `;
        planTbody.appendChild(tr);
      }
    }

    function clearPlanning(){
      if(!confirm("Apagar TODO o planejamento importado?")) return;
      savePlan([]);
      fillContentFromPlan();
      renderPlanModal();
      showToast("Planejamento apagado", "A lista de conteúdos ficará vazia até importar novamente.");
    }

    /**********************
     * Header line
     **********************/
    function updateHeaderLine(){
      const d = elDate.value ? formatBR(elDate.value) : "—";
      elSubLine.textContent = `${d} • ${elSegment.value} • Turma ${elTurma.value} • Aula ${elAula.value}`;
    }

    /**********************
     * Global print (imprimir página)
     **********************/
    function printPage(){
      window.print();
    }

    /**********************
     * Events
     **********************/
    document.addEventListener("DOMContentLoaded", () => {
      // default date: hoje
      const today = toISODate(new Date());
      elDate.value = today;

      // aula options inicial
      elAula.innerHTML = "";
      for(let i=1;i<=30;i++){
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        elAula.appendChild(opt);
      }
      elAula.value = "1";

      // conteúdo inicial
      fillContentFromPlan();
      rebuildAulaOptions(false);
      updateHeaderLine();

      // lista
      renderList();
      updateWeeks();

      // handlers
      btnSave.addEventListener("click", saveCurrent);

      btnPrint.addEventListener("click", printPage);
      btnPrintWeek.addEventListener("click", printWeek);

      btnExport.addEventListener("click", exportJSON);
      btnImport.addEventListener("click", () => fileJson.click());

      btnPlanExcel.addEventListener("click", () => fileExcel.click());
      btnViewPlan.addEventListener("click", openPlanModal);

      btnClearFilter.addEventListener("click", () => {
        elFilter.value = "";
        renderList();
      });

      // filtros
      elFilter.addEventListener("input", renderList);

      // mudanças de form -> autoload + regras
      elDate.addEventListener("change", () => { rebuildAulaOptions(false); autoLoadIfExists(); updateWeeks(); });
      elSegment.addEventListener("change", () => { fillContentFromPlan(); rebuildAulaOptions(false); autoLoadIfExists(); });
      elTurma.addEventListener("change", () => { fillContentFromPlan(); rebuildAulaOptions(false); autoLoadIfExists(); });
      elAula.addEventListener("change", () => { autoLoadIfExists(); });

      // clicar na lista (delegação)
      elList.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        const action = btn.dataset.action;
        const key = btn.dataset.key;
        if(!action || !key) return;

        const all = loadAllRecords();
        const r = all.find(x => recordKey(x) === key);
        if(action === "load"){
          if(!r) return;
          setFormData(r);
          // ao carregar, permitir editar a aula carregada
          rebuildAulaOptions(true);
          showToast("Carregado", "Você pode editar e salvar novamente.");
        }
        if(action === "del"){
          if(!confirm("Excluir este registro?")) return;
          deleteRecord(key);
        }
      });

      // JSON file change
      fileJson.addEventListener("change", () => {
        const f = fileJson.files?.[0];
        fileJson.value = "";
        if(!f) return;
        importJSONFile(f);
      });

      // Excel planning change
      fileExcel.addEventListener("change", () => {
        const f = fileExcel.files?.[0];
        fileExcel.value = "";
        if(!f) return;
        importPlanningExcel(f);
      });

      // Modal
      btnClosePlan.addEventListener("click", closePlanModal);
      btnClearPlan.addEventListener("click", clearPlanning);
      planFilter.addEventListener("input", renderPlanModal);

      planModal.addEventListener("click", (e) => {
        if(e.target === planModal) closePlanModal();
      });

      // Register SW (se existir)
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      }
    });
  </script>
</body>
</html>
